---
description: Kotlin類註釋規範
globs: ["**/*.kt"]
alwaysApply: true
---

# Kotlin類註釋規範

## 0. 適用範圍
- 適用於：Kotlin 專案中的 `class / object / interface / enum`
- 目標：用一致格式規範「類註釋」到可維護水準

---

## 1. 總體原則
- 類註釋要回答：**它是什麼、為何存在、邊界在哪、怎麼用、踩坑是什麼**
- 優先描述 **業務含義與行為契約**，其次才是實作細節
- 避免「從類名翻譯」式廢話（例：`UserService 用戶服務`）
- 內容以 **可驗證** 為準：能從代碼/依賴/流程推導或在測試覆蓋到

---

## 2. KDoc 統一結構（必須按順序）
> 類註釋必須使用 KDoc（`/** ... */`），且段落標題固定如下。

1) **一句話摘要（Summary）**
- 用動詞開頭 + 直接點出核心價值
- 長度建議 20~40 字

2) **背景與使用場景（Context）**
- 說明它位於什麼流程/模組/分層中（Controller/Service/Repository/Client/Job/Listener…）
- 說明由誰調用、何時被調用

3) **責任邊界（Responsibilities）**
- 3~7 條要點列出做什麼

4) **不負責（Non-goals）**
- 明確不做的事（至少 1~3 條），避免誤用/擴散

5) **核心流程（Key Flow）**
- 用 3~6 條描述主流程步驟（偏「做了哪些判斷/組合/調用」）
- 若有「順序敏感」需點出

6) **依賴與外部交互（Dependencies & IO）**
- 列出關鍵依賴（Repository / Client / Clock / TransactionTemplate / EventPublisher…）
- 標註是否涉及 IO：DB / HTTP / MQ / Cache / File
- 若依賴為可替換策略（Strategy/Policy），要說明選擇規則

7) **資料/契約（Contracts）**
- **輸入假設**：允許空值嗎、必填字段、合法範圍
- **輸出保證**：返回值含義、是否可能為空
- **例外/錯誤**：會拋哪些異常、何時拋、是否包裝
- 若使用 `Result/Either` 風格，也要寫清楚錯誤碼語義

8) **交易與一致性（Transactions & Consistency）**
- 是否 `@Transactional`，隔離級別/傳播行為（若可從註解判斷）
- 一致性策略：本地事務/最終一致/事件驅動/補償
- 若有「重試」或「冪等」，必須寫

9) **並發與線程安全（Concurrency）**
- 是否無狀態（可 Singleton）
- 是否有可變狀態（mutable fields / caches）
- 是否多線程調用（Job/Listener/Web）

10) **性能特性（Performance）**
- 是否可能 N+1、批量查詢、分頁、流式處理
- 主要時間/空間成本（大概即可，但要指向原因）
- 是否有快取，快取鍵與失效策略

11) **安全與合規（Security）**
- 是否涉及敏感數據（個資、Token、密碼、支付）
- 是否需要脫敏/審計/權限校驗（如方法內有校驗則描述）

12) **使用示例（Usage Example）**
- 至少 1 段簡短 Kotlin 示例（可偽代碼，但要像真代碼）
- 入口方法建議點名

13) **變更注意（Change Notes，可選但推薦）**
- 若近期做過重大改動：列 1~3 條

14) **@since**
- 必填，取當前最新的版本，如：`@since 1.0.0`

15) **@author**
- 必填

---

## 3. Cursor 生成/重寫註釋的具體規則（for cursor用來改舊代碼）
當 Cursor 要為「既有類」補註釋時，必須：
1. **先讀類名、註解與公開方法**
   - 特別關注：`@Service/@Component/@Repository/@RestController/@Configuration/@Scheduled/@KafkaListener/...`
2. **掃描依賴（constructor 注入）**
   - 依賴名推斷 IO 類型：Repository=DB、Client=HTTP、Template=外部、Publisher=事件
3. **從主公開方法推主流程**
   - 以「最常用/最核心的 public 方法」為入口
4. **從註解推交易/並發**
   - `@Transactional`、`@Async`、`@Scheduled`、Listener 類推多線程/重入風險
5. **不允許胡編**
   - 不能憑空寫不存在的外部系統、表名、MQ topic、快取 key
   - 不確定的地方用「可觀察描述」：
     - ✅「會調用 XClient 發起 HTTP 請求」
     - ❌「調用支付寶接口扣款」（除非代碼能證明）
6. **已有註釋要保留意圖**
   - 保留原註釋中仍然正確的內容，重排到本規範段落中
7. **優先補齊缺失段落**
   - 先補 Summary/Context/Responsibilities/Non-goals/Usage
   - 再補 Transactions/Performance/Security

---

## 4. KDoc 模板（直接套用）
/**
 * 【Summary】以動詞開頭的一句話摘要。
 *
 * ## 背景與使用場景
 * - ...
 *
 * ## 責任邊界
 * - ...
 *
 * ## 不負責
 * - ...
 *
 * ## 核心流程
 * 1. ...
 * 2. ...
 *
 * ## 依賴與外部交互
 * - 依賴：...
 * - IO：DB/HTTP/MQ/Cache/None（按實際填）
 *
 * ## 資料/契約
 * - 輸入：...
 * - 輸出：...
 * - 錯誤：...
 *
 * ## 交易與一致性
 * - 事務：...
 * - 冪等/重試：...
 *
 * ## 並發與線程安全
 * - ...
 *
 * ## 性能特性
 * - ...
 *
 * ## 安全與合規
 * - ...
 *
 * ## 使用示例
 * ```kotlin
 * // ...
 * ```
 *
 * @since 1.0.0
 */

---

## 5. 分層補充規範（Spring 常見類型）
### 5.1 Controller 類（@RestController）
- Context：對應哪組 API，面向哪類客戶端（Web/App/內部）
- Contracts：URL/權限/輸入校驗/錯誤碼映射（若可從代碼看出）
- Non-goals：不處理業務計算、不直接訪問 DB（如符合實際）

### 5.2 Service 類（@Service）
- Responsibilities：編排流程、事務邊界、策略選擇、事件發佈
- Transactions：務必寫清楚是否 `@Transactional` 以及原因

### 5.3 Repository 類（@Repository）
- 性能特性：索引/分頁/批量操作（僅在代碼能看出時）
- Contracts：查無資料時返回 null/empty/exception

### 5.4 Client 類（HTTP/RPC）
- 依賴與外部交互：外部系統名稱（以代碼中的 client 名稱為準）
- 重試/超時/熔斷：若代碼/配置能證明才寫

### 5.5 Job/Listener（@Scheduled / @KafkaListener / @EventListener）
- 並發：是否可能重入、是否允許並行
- 冪等：如何保證重複消息/重跑不出問題

---

## 6. 最小驗收清單（改完舊代碼後必須滿足）
- [ ] 有 Summary
- [ ] 有 Responsibilities + Non-goals
- [ ] 有 Dependencies & IO
- [ ] 有 Contracts（至少輸入/錯誤）
- [ ] 若涉及事務/重試/冪等/並發，對應段落不為空
- [ ] 有 Usage Example
- [ ] 有 @author 和 @since

---

## 7. Cursor 提示詞模板（直接複製使用）
> 你可以把這段當作「固定提示詞」，在 Cursor 對選中的 class 執行 rewrite/生成註釋時貼上。
> 若 Cursor 會自動讀取 Project Rules，也可以不貼，但建議在批量改舊代碼時搭配使用。

### 7.1 生成/補全類註釋
請為**選中的 Kotlin 類**補全或重寫 KDoc 類註釋，要求：
- 嚴格使用本規則文件的 **「KDoc 統一結構」**段落與順序
- 僅根據代碼可證明的信息描述：類註解、構造注入依賴、public 方法、調用關係、可見常量
- 禁止臆測外部系統名稱、MQ topic、表名、快取 key、SLA 等；不確定就用可觀察描述
- 需要時補充：事務/一致性、冪等/重試、並發/重入、性能風險（N+1/批量/分頁）、安全（敏感字段/脫敏/審計）
- 必須包含至少一段 `Usage Example`（Kotlin code block）
- 必須包含 @author 和 @since
- 保留原有仍正確的註釋意圖，但重排到對應段落
輸出：只輸出最終 KDoc 註釋 +（如有需要）最小幅度調整的類級別註解說明文字；不要輸出其它解釋。